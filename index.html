<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</title>
    <style>
        /* ---------------------------------- */
/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© ÙˆÙ…Ø­Ø§Ø°Ø§Ø© RTL    */
/* ---------------------------------- */
body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f4f9;
    color: #333;
    direction: rtl; /* Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
    text-align: right;
}

header {
    background-color: #2c3e50;
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

header h1 {
    margin: 0;
}

.header-controls {
    display: flex;
    gap: 15px;
    align-items: center;
}

.dashboard {
    padding: 20px;
}

.hidden {
    display: none !important;
}

/* ---------------------------------- */
/* ğŸ” Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„            */
/* ---------------------------------- */
.login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #2c3e50; /* Ø£Ø³ÙˆØ¯/Ø¯Ø§ÙƒÙ† */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    color: white;
}

.login-box {
    background: #34495e;
    padding: 40px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    text-align: center;
}

.login-box input[type="password"] {
    padding: 10px;
    margin: 15px 0;
    width: 250px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    text-align: center;
}

.login-box button {
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}

.login-box button:hover {
    background-color: #c0392b;
}

.error-message {
    color: #f1c40f;
    margin-top: 10px;
    font-weight: bold;
}

/* ---------------------------------- */
/* ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª             */
/* ---------------------------------- */
.stats-section {
    margin: 20px 0;
    border-bottom: 2px solid #ccc;
    padding-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.stats-grid > div {
    background: #ecf0f1;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.stats-grid h3, .stats-grid h4 {
    margin-top: 0;
    color: #3498db;
    font-size: 1.1em;
}

.stats-grid p {
    font-size: 1.8em;
    font-weight: bold;
    color: #2c3e50;
    margin: 5px 0 0 0;
}

/* ---------------------------------- */
/* ğŸ‘¤ Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø©         */
/* ---------------------------------- */
.controls-section {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.controls-section input[type="text"] {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    flex-grow: 1;
}

.main-btn {
    background-color: #2ecc71;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.main-btn:hover { background-color: #27ae60; }

.action-btn {
    background-color: #f39c12;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.action-btn:hover { background-color: #e67e22; }

.secondary-btn {
    background-color: #3498db;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.secondary-btn:hover { background-color: #2980b9; }

.filter-btn {
    background-color: #9b59b6;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.filter-btn.active {
    background-color: #8e44ad;
}

/* ---------------------------------- */
/* Ø§Ù„Ø¬Ø¯ÙˆÙ„              */
/* ---------------------------------- */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background-color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
}

th, td {
    padding: 12px 15px;
    border: 1px solid #ddd;
    text-align: right;
}

th {
    background-color: #3498db;
    color: white;
}

tr:nth-child(even) {
    background-color: #f2f2f2;
}

/* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
.action-buttons button, .payment-toggle-btn {
    padding: 8px 12px;
    margin: 2px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.edit-btn { background-color: #f1c40f; color: #333; }
.delete-btn { background-color: #e74c3c; color: white; }
.history-btn { background-color: #95a5a6; color: white; }

.payment-toggle-btn.paid {
    background-color: #2ecc71;
    color: white;
}
.payment-toggle-btn.due {
    background-color: #e67e22;
    color: white;
}

/* ---------------------------------- */
/* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©        */
/* ---------------------------------- */
.modal {
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #fefefe;
    padding: 30px;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    position: relative;
}

.large-modal {
    max-width: 800px;
}

.close-btn {
    color: #aaa;
    float: left; /* Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ù„Ù„ÙŠØ³Ø§Ø± ÙÙŠ RTL */
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    top: 10px;
    left: 20px;
}

.close-btn:hover,
.close-btn:focus {
    color: #333;
    text-decoration: none;
}

.modal-content label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
}

.modal-content input, .modal-content select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    margin-bottom: 10px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.modal-content button[type="submit"], #save-client-btn, #view-selected-month-btn {
    width: 100%;
    background-color: #2ecc71;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 20px;
}

/* Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
.history-table {
    margin-top: 20px;
}

.history-table th {
    background-color: #95a5a6;
}

/* Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
.extra-features {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    padding-top: 10px;
    border-top: 2px dashed #ccc;
    flex-wrap: wrap;
}

#import-data-file {
    /* Ù„Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù ÙˆØ¬Ø¹Ù„Ù‡ ÙŠØ¹Ù…Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø²Ø± */
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}
    </style>
</head>
<body>

    <div id="login-screen" class="login-screen">
        <div class="login-box">
            <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h1>
           
            <input type="password" id="password-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button id="login-button">Ø¯Ø®ÙˆÙ„</button>
            <p id="login-message" class="error-message"></p>
        </div>
    </div>

    <div id="dashboard" class="dashboard hidden">
        
        <header>
            <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h1>
            <div class="header-controls">
                <span id="current-month-display"></span>
                <button id="start-new-month-btn" class="action-btn">ğŸ“… Ø§Ø¨Ø¯Ø£ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯</button>
            </div>
        </header>

        <section class="stats-section">
            <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
            <div class="stats-grid">
                <div>
                    <h3>Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ</h3>
                    <p id="total-clients-stat">0</p>
                </div>
                <div>
                    <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</h3>
                    <p id="expected-income-stat">0 Ø¬.Ù…</p>
                </div>
                <div>
                    <h3>Ø§Ù„Ù…Ø­ØµÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</h3>
                    <p id="paid-income-stat">0 Ø¬.Ù…</p>
                </div>
                <div>
                    <h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†</h3>
                    <p id="due-clients-stat">0</p>
                </div>
            </div>
        </section>

        <section class="controls-section">
            <button id="add-client-btn" class="main-btn">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</button>
            <input type="text" id="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ">
            <button id="toggle-due-btn" class="filter-btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† ÙÙ‚Ø·</button>
        </section>

        <section class="data-section">
            <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                        <th>Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ø¯ÙØ¹</th>
                        <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="clients-table-body">
                    </tbody>
            </table>
        </section>

        <section class="extra-features">
            <h2>Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h2>
            <button id="open-monthly-viewer-btn" class="secondary-btn">ğŸ“† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„ Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚</button>
            <button id="export-data-btn" class="secondary-btn">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
            <input type="file" id="import-data-file" accept="application/json" class="hidden">
            <button id="import-data-btn" class="secondary-btn">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
        </section>
        
    </div>

    <div id="client-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="client-modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ</h2>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <label for="client-name">Ø§Ù„Ø§Ø³Ù…:</label>
                <input type="text" id="client-name" required>
                <label for="client-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                <input type="tel" id="client-phone" required>
                <button type="submit" id="save-client-btn">Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <div id="history-modal" class="modal hidden">
        <div class="modal-content large-modal">
            <span class="close-btn">&times;</span>
            <h2 id="history-modal-title">Ø³Ø¬Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª: [Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ]</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø´Ù‡Ø±</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    </tr>
                </thead>
                <tbody id="client-history-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="monthly-viewer-modal" class="modal hidden">
        <div class="modal-content large-modal">
            <span class="close-btn">&times;</span>
            <h2>Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚</h2>
            <label for="month-select">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
            <select id="month-select"></select>
            <button id="view-selected-month-btn" class="secondary-btn">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>

            <div id="monthly-record-display" class="hidden">
                <hr>
                <h3 id="viewed-month-title">Ø³Ø¬Ù„ Ø´Ù‡Ø±: </h3>
                <div class="stats-grid month-viewer-stats">
                    <div>
                        <h4>Ø§Ù„Ù…Ø­ØµÙ„</h4>
                        <p id="viewer-paid-income">0 Ø¬.Ù…</p>
                    </div>
                    <div>
                        <h4>Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†</h4>
                        <p id="viewer-due-clients">0</p>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-viewer-body">
                        </tbody>
                </table>
                <button id="export-monthly-csv-btn" class="action-btn">ğŸ“¥ ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± CSV</button>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // ----------------------------------------------------
    //        ğŸ—„ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (LocalStorage)
    // ----------------------------------------------------
    const STORAGE_KEY = 'subscriptionManagerData';
    const PASSWORD = '1999';
    const MONTHLY_FEE = 60;
    
    // Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    let appData = {
        currentMonth: getCurrentMonthKey(), // "YYYY-MM"
        clients: []
    };

    /**
     * ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (YYYY-MM).
     * @returns {string} Ù…ÙØªØ§Ø­ Ø§Ù„Ø´Ù‡Ø±.
     */
    function getCurrentMonthKey() {
        const now = new Date();
        const year = now.getFullYear();
        // Ø§Ù„Ø´Ù‡Ø± ÙŠØªÙ… Ø¥Ø¶Ø§ÙÙ‡ 1 Ù„Ù‡ Ù„Ø£Ù†Ù‡ ÙŠØ¨Ø¯Ø£ Ù…Ù† 0ØŒ Ø«Ù… ÙŠØªÙ… ØªÙ†Ø³ÙŠÙ‚Ù‡ Ù„ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ù‚Ù„ Ù…Ù† 10
        const month = String(now.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}`;
    }

    /**
     * Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage.
     */
    function loadData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            appData = JSON.parse(storedData);
            // ØªØ­Ø¯ÙŠØ« Ù…ÙØªØ§Ø­ Ø§Ù„Ø´Ù‡Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø£Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø®Ø²Ù†
            if (appData.currentMonth < getCurrentMonthKey()) {
                appData.currentMonth = getCurrentMonthKey();
            }
        } else {
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø´ÙŠØ¡
            saveData(); 
        }
    }

    /**
     * Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage.
     */
    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
    }

    /**
     * Ø¥ÙŠØ¬Ø§Ø¯ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ø´Ù‡Ø± Ù…Ø¹ÙŠÙ†.
     * @param {object} client - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ.
     * @param {string} monthKey - Ù…ÙØªØ§Ø­ Ø§Ù„Ø´Ù‡Ø± (YYYY-MM).
     * @returns {object|undefined} Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ø°Ù„Ùƒ Ø§Ù„Ø´Ù‡Ø±.
     */
    function getPaymentRecord(client, monthKey) {
        return client.payments.find(p => p.month === monthKey);
    }

    /**
     * Ø¥ÙŠØ¬Ø§Ø¯ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.
     * @param {object} client - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ.
     * @returns {object|undefined} Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.
     */
    function getCurrentMonthPayment(client) {
        return getPaymentRecord(client, appData.currentMonth);
    }
    
    // ----------------------------------------------------
    //                 ğŸ” Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    // ----------------------------------------------------
    const loginScreen = document.getElementById('login-screen');
    const dashboard = document.getElementById('dashboard');
    const passwordInput = document.getElementById('password-input');
    const loginButton = document.getElementById('login-button');
    const loginMessage = document.getElementById('login-message');

    /**
     * Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.
     */
    function handleLogin() {
        if (passwordInput.value === PASSWORD) {
            loginScreen.classList.add('hidden');
            dashboard.classList.remove('hidden');
            loadData();
            renderDashboard(); // Ø¨Ø¯Ø¡ Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
        } else {
            loginMessage.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
            setTimeout(() => loginMessage.textContent = '', 3000);
        }
    }

    loginButton.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleLogin();
        }
    });

    // ----------------------------------------------------
    //        ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙˆÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // ----------------------------------------------------
    const clientsTableBody = document.getElementById('clients-table-body');
    const searchInput = document.getElementById('search-input');
    const toggleDueBtn = document.getElementById('toggle-due-btn');
    let isFilteringDue = false;

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª.
     * @param {Array<object>} [clientsToRender] - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù„Ø¹Ø±Ø¶Ù‡Ø§ (Ù„Ù„Ø¨Ø­Ø«/Ø§Ù„ÙÙ„ØªØ±Ø©).
     */
    function renderDashboard(clientsToRender = appData.clients) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
        document.getElementById('current-month-display').textContent = `Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: ${appData.currentMonth}`;

        clientsTableBody.innerHTML = '';
        
        let totalPaidIncome = 0;
        let totalDueClients = 0;
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙØ¹Ù„Ø©
        let filteredClients = clientsToRender;
        if (isFilteringDue) {
            filteredClients = filteredClients.filter(client => {
                const currentPayment = getCurrentMonthPayment(client);
                // Ù…ØªØ£Ø®Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¯ÙØ¹ (Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ùˆ paid: false)
                return !currentPayment || !currentPayment.paid; 
            });
        }


        filteredClients.forEach(client => {
            const currentPayment = getCurrentMonthPayment(client);
            const isPaid = currentPayment && currentPayment.paid;

            const lastPaidDateRecord = client.payments
                .filter(p => p.paid)
                .sort((a, b) => b.month.localeCompare(a.month)) // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
                .shift(); // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø«

            if (isPaid) {
                totalPaidIncome += MONTHLY_FEE;
            } else {
                // Ù†Ø¹ØªØ¨Ø±Ù‡ Ù…ØªØ£Ø®Ø±Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¯ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø·
                totalDueClients++; 
            }
            
            const row = clientsTableBody.insertRow();
            row.innerHTML = `
                <td>${client.name}</td>
                <td>${client.phone}</td>
                <td>${lastPaidDateRecord ? lastPaidDateRecord.datePaid.split(',')[0] : 'Ù„Ù… ÙŠØ¯ÙØ¹ Ø³Ø§Ø¨Ù‚Ø§Ù‹'}</td>
                <td>
                    <button 
                        data-id="${client.id}" 
                        class="payment-toggle-btn ${isPaid ? 'paid' : 'due'}"
                        title="ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (${appData.currentMonth})"
                    >
                        ${isPaid ? 'Ù…Ø¯ÙÙˆØ¹' : 'Ù…ØªØ£Ø®Ø±'}
                    </button>
                </td>
                <td>
                    <button data-id="${client.id}" class="edit-btn">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button data-id="${client.id}" class="delete-btn">Ø­Ø°Ù</button>
                    <button data-id="${client.id}" class="history-btn">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</button>
                </td>
            `;
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateStats(totalPaidIncome, totalDueClients);
    }
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….
     */
    function updateStats(paidIncome, dueClients) {
        const totalClients = appData.clients.length;
        document.getElementById('total-clients-stat').textContent = totalClients;
        document.getElementById('expected-income-stat').textContent = `${totalClients * MONTHLY_FEE} Ø¬.Ù…`;
        document.getElementById('paid-income-stat').textContent = `${paidIncome} Ø¬.Ù…`;
        document.getElementById('due-clients-stat').textContent = dueClients;
    }

    // Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´ØªØ±Ùƒ
    const clientModal = document.getElementById('client-modal');
    const clientForm = document.getElementById('client-form');
    const clientIdInput = document.getElementById('client-id');
    const clientNameInput = document.getElementById('client-name');
    const clientPhoneInput = document.getElementById('client-phone');
    const modalTitle = document.getElementById('client-modal-title');
    
    document.getElementById('add-client-btn').addEventListener('click', () => {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø¥Ø¶Ø§ÙØ©
        clientIdInput.value = '';
        clientForm.reset();
        modalTitle.textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯';
        clientModal.classList.remove('hidden');
    });

    clientForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const id = clientIdInput.value;
        const name = clientNameInput.value.trim();
        const phone = clientPhoneInput.value.trim();

        if (id) {
            // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´ØªØ±Ùƒ
            const client = appData.clients.find(c => c.id === id);
            if (client) {
                client.name = name;
                client.phone = phone;
                alert(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ ${name}`);
            }
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
            const newClient = {
                id: Date.now().toString(), // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ø¨Ø³ÙŠØ·
                name,
                phone,
                payments: []
            };
            appData.clients.push(newClient);
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ ${name}`);
        }
        
        saveData();
        renderDashboard();
        clientModal.classList.add('hidden');
    });

    // ØªÙÙˆÙŠØ¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°ÙØŒ Ø³Ø¬Ù„ØŒ ØªØ¨Ø¯ÙŠÙ„ Ø¯ÙØ¹)
    clientsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        const clientId = target.getAttribute('data-id');
        const client = appData.clients.find(c => c.id === clientId);

        if (!client) return;
        
        if (target.classList.contains('edit-btn')) {
            // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø´ØªØ±Ùƒ
            clientIdInput.value = client.id;
            clientNameInput.value = client.name;
            clientPhoneInput.value = client.phone;
            modalTitle.textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ';
            clientModal.classList.remove('hidden');
        } else if (target.classList.contains('delete-btn')) {
            // Ø­Ø°Ù Ù…Ø´ØªØ±Ùƒ
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ ${client.name} Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ`)) {
                appData.clients = appData.clients.filter(c => c.id !== clientId);
                saveData();
                renderDashboard();
                alert(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ ${client.name}.`);
            }
        } else if (target.classList.contains('history-btn')) {
            // Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
            showClientHistory(client);
        } else if (target.classList.contains('payment-toggle-btn')) {
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
            togglePaymentStatus(client);
        }
    });

    // Ø§Ù„Ø¨Ø­Ø«
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim().toLowerCase();
        const searchResults = appData.clients.filter(client => 
            client.name.toLowerCase().includes(query) || client.phone.includes(query)
        );
        renderDashboard(searchResults);
    });

    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†
    toggleDueBtn.addEventListener('click', () => {
        isFilteringDue = !isFilteringDue;
        toggleDueBtn.classList.toggle('active', isFilteringDue);
        toggleDueBtn.textContent = isFilteringDue ? 'âœ… Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„' : 'Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ† ÙÙ‚Ø·';
        renderDashboard();
    });

    // ----------------------------------------------------
    //                 ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
    // ----------------------------------------------------
    
    /**
     * ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¯ÙØ¹ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.
     * @param {object} client - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ.
     */
    function togglePaymentStatus(client) {
        let currentPayment = getPaymentRecord(client, appData.currentMonth);
        
        if (!currentPayment) {
            // Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
            currentPayment = {
                month: appData.currentMonth,
                paid: true,
                datePaid: new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' }),
                amount: MONTHLY_FEE
            };
            client.payments.push(currentPayment);
            alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ ${client.name} Ù„Ù„Ø´Ù‡Ø± ${appData.currentMonth}.`);
        } else if (currentPayment.paid) {
            // Ø§Ù„Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø§Ù„ØªÙ‡ "Ù…Ø¯ÙÙˆØ¹": Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹ ÙˆØ­Ø°Ù Ø§Ù„Ø³Ø¬Ù„
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø¯ÙØ¹ ${client.name} Ù„Ù„Ø´Ù‡Ø± ${appData.currentMonth}ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹.`)) {
                client.payments = client.payments.filter(p => p.month !== appData.currentMonth);
                alert(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¯ÙØ¹ ${client.name} Ù„Ù„Ø´Ù‡Ø± ${appData.currentMonth}.`);
            } else {
                return;
            }
        } else {
            // Ø§Ù„Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ­Ø§Ù„ØªÙ‡ "Ù…ØªØ£Ø®Ø±": ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù…Ø¯ÙÙˆØ¹" (Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ù†Ø§Ø¯Ø±Ø© Ù„Ø£Ù†Ù‡ ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡)
            // Ù„ÙƒÙ† Ø³Ù†Ø¶ÙŠÙ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø­Ø§Ù„Ø© ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙˆØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            currentPayment.paid = true;
            currentPayment.datePaid = new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' });
            alert(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ ${client.name} Ù„Ù„Ø´Ù‡Ø± ${appData.currentMonth}.`);
        }
        
        saveData();
        renderDashboard();
    }
    
    // ----------------------------------------------------
    //                 ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    // ----------------------------------------------------
    
    document.getElementById('start-new-month-btn').addEventListener('click', () => {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯ØŸ Ø³ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø­Ø§Ù„Ø© "Ù…ØªØ£Ø®Ø±".')) {
            startNewMonth();
        }
    });

    /**
     * Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„ØªØ§Ù„ÙŠ.
     */
    function getNextMonthKey(currentMonthKey) {
        let [year, month] = currentMonthKey.split('-').map(Number);
        
        if (month === 12) {
            year += 1;
            month = 1;
        } else {
            month += 1;
        }
        
        const nextMonth = String(month).padStart(2, '0');
        return `${year}-${nextMonth}`;
    }

    /**
     * Ø¨Ø¯Ø¡ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯.
     */
    function startNewMonth() {
        const nextMonthKey = getNextMonthKey(appData.currentMonth);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        appData.currentMonth = nextMonthKey;
        
        // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù€ "ØªØ±Ø­ÙŠÙ„" Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†ØŒ ÙÙ‚Ø· Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…ÙØªØ§Ø­ Ø§Ù„Ø´Ù‡Ø± Ù‚Ø¯ ØªØºÙŠØ±.
        // Ø£ÙŠ Ù…Ø´ØªØ±Ùƒ Ù„Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙ‡ Ø³Ø¬Ù„ Ø¯ÙØ¹ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ ÙˆØ¨Ø§Ù„ØªØ§Ù„ÙŠ Ø³ÙŠØ¸Ù‡Ø± ÙƒÙ€ "Ù…ØªØ£Ø®Ø±" ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
        
        saveData();
        renderDashboard();
        alert(`ØªÙ… Ø¨Ø¯Ø¡ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­: ${nextMonthKey}.`);
    }

    // ----------------------------------------------------
    //        ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù„ÙƒÙ„ Ù…Ø´ØªØ±Ùƒ
    // ----------------------------------------------------
    const historyModal = document.getElementById('history-modal');
    const clientHistoryBody = document.getElementById('client-history-body');

    /**
     * Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ù…Ù†Ø¨Ø«Ù‚.
     */
    function showClientHistory(client) {
        document.getElementById('history-modal-title').textContent = `Ø³Ø¬Ù„ Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${client.name}`;
        clientHistoryBody.innerHTML = '';

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØªÙ†Ø§Ø²Ù„ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±
        const sortedPayments = client.payments
            .filter(p => p.paid) // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙ‚Ø·
            .sort((a, b) => b.month.localeCompare(a.month)); 

        sortedPayments.forEach(payment => {
            const row = clientHistoryBody.insertRow();
            const datePaidText = payment.datePaid.split(',').join(' '); // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø¨ÙˆØ¶ÙˆØ­

            row.innerHTML = `
                <td>${payment.month}</td>
                <td style="color: #2ecc71; font-weight: bold;">Ù…Ø¯ÙÙˆØ¹</td>
                <td>${datePaidText}</td>
                <td>${payment.amount} Ø¬.Ù…</td>
            `;
        });

        historyModal.classList.remove('hidden');
    }
    
    // ----------------------------------------------------
    //        ğŸ“† Ø¹Ø±Ø¶ Ø³Ø¬Ù„ ÙƒÙ„ Ø´Ù‡Ø± Ù„ÙˆØ­Ø¯Ù‡
    // ----------------------------------------------------
    const monthlyViewerModal = document.getElementById('monthly-viewer-modal');
    const monthSelect = document.getElementById('month-select');
    const monthlyRecordDisplay = document.getElementById('monthly-record-display');
    const monthlyViewerBody = document.getElementById('monthly-viewer-body');
    const exportMonthlyCsvBtn = document.getElementById('export-monthly-csv-btn');
    let viewedMonthKey = null; 

    document.getElementById('open-monthly-viewer-btn').addEventListener('click', () => {
        populateMonthSelect();
        monthlyViewerModal.classList.remove('hidden');
        monthlyRecordDisplay.classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    });
    
    /**
     * ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.
     */
    function populateMonthSelect() {
        monthSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø´Ù‡Ø±Ù‹Ø§ --</option>';
        
        const allMonths = new Set();
        appData.clients.forEach(client => {
            client.payments.forEach(p => allMonths.add(p.month));
        });
        
        allMonths.add(appData.currentMonth); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ÙˆÙØ±Ø²Ù‡Ø§ ØªÙ†Ø§Ø²Ù„ÙŠÙ‹Ø§
        const sortedMonths = Array.from(allMonths).sort().reverse();
        
        sortedMonths.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            monthSelect.appendChild(option);
        });
    }

    document.getElementById('view-selected-month-btn').addEventListener('click', () => {
        viewedMonthKey = monthSelect.value;
        if (!viewedMonthKey) {
            alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø´Ù‡Ø± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.');
            return;
        }
        
        renderMonthlyRecord(viewedMonthKey);
        monthlyRecordDisplay.classList.remove('hidden');
    });

    /**
     * Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯.
     */
    function renderMonthlyRecord(monthKey) {
        monthlyViewerBody.innerHTML = '';
        
        let totalPaidIncome = 0;
        let totalDueClients = 0;

        document.getElementById('viewed-month-title').textContent = `Ø³Ø¬Ù„ Ø´Ù‡Ø±: ${monthKey}`;
        
        appData.clients.forEach(client => {
            const payment = getPaymentRecord(client, monthKey);
            
            const isPaid = payment && payment.paid;
            
            if (isPaid) {
                totalPaidIncome += MONTHLY_FEE;
            } else {
                totalDueClients++;
            }
            
            const row = monthlyViewerBody.insertRow();
            const statusText = isPaid ? 'Ù…Ø¯ÙÙˆØ¹' : 'Ù…ØªØ£Ø®Ø±';
            const datePaidText = isPaid ? payment.datePaid.split(',').join(' ') : '-';

            row.innerHTML = `
                <td>${client.name}</td>
                <td style="color: ${isPaid ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">${statusText}</td>
                <td>${datePaidText}</td>
            `;
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø±
        document.getElementById('viewer-paid-income').textContent = `${totalPaidIncome} Ø¬.Ù…`;
        document.getElementById('viewer-due-clients').textContent = totalDueClients;
    }
    
    // ----------------------------------------------------
    //             ğŸ“¤ğŸ“¥ Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
    // ----------------------------------------------------
    
    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª JSON (Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
    document.getElementById('export-data-btn').addEventListener('click', () => {
        exportJSON(appData, 'subscription_manager_backup');
    });

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù JSON.
     */
    function exportJSON(data, filenameBase) {
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filenameBase}_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª JSON
    const importFile = document.getElementById('import-data-file');
    document.getElementById('import-data-btn').addEventListener('click', () => {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙŠØ­Ù…Ù„ÙˆÙ† Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù† ÙŠØªÙƒØ±Ø±ÙˆØ§.')) {
            importFile.click();
        }
    });

    importFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const importedData = JSON.parse(event.target.result);
                if (importedData && importedData.clients && Array.isArray(importedData.clients)) {
                    mergeData(importedData);
                    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¯Ù…Ø¬Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!');
                } else {
                    alert('Ù‡ÙŠÙƒÙ„ Ù…Ù„Ù JSON ØºÙŠØ± ØµØ­ÙŠØ­ Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯.');
                }
            } catch (error) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù JSON: ' + error.message);
            }
            e.target.value = ''; 
        };
        reader.readAsText(file);
    });

    /**
     * Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø­Ø³Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ).
     */
    function mergeData(importedData) {
        const existingPhones = new Set(appData.clients.map(c => c.phone));
        
        importedData.clients.forEach(newClient => {
            if (!existingPhones.has(newClient.phone)) {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                appData.clients.push({
                    ...newClient,
                    id: newClient.id || Date.now().toString() 
                });
            } else {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ØŒ Ù†Ø¯Ù…Ø¬ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯ÙØ¹
                const existingClient = appData.clients.find(c => c.phone === newClient.phone);
                if (existingClient) {
                    newClient.payments.forEach(newPayment => {
                        const exists = existingClient.payments.some(p => p.month === newPayment.month);
                        if (!exists) {
                            existingClient.payments.push(newPayment);
                        }
                    });
                }
            }
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ø¯Ø«
        if (importedData.currentMonth > appData.currentMonth) {
            appData.currentMonth = importedData.currentMonth;
        }

        saveData();
        renderDashboard();
    }
    
    // ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± CSV
    exportMonthlyCsvBtn.addEventListener('click', () => {
        const monthToExport = viewedMonthKey || appData.currentMonth;
        
        let csvContent = 'data:text/csv;charset=utf-8,\uFEFF'; 
        csvContent += 'Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ø´Ù‡Ø±,Ø§Ù„Ø­Ø§Ù„Ø©,ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹,Ø§Ù„Ù…Ø¨Ù„Øº\n';
        
        appData.clients.forEach(client => {
            const payment = getPaymentRecord(client, monthToExport);
            
            const isPaid = payment && payment.paid;
            const statusText = isPaid ? 'Ù…Ø¯ÙÙˆØ¹' : 'Ù…ØªØ£Ø®Ø±';
            const datePaidText = isPaid ? payment.datePaid.split(',').join(' ') : '-';
            const amount = isPaid ? MONTHLY_FEE : 0;
            
            const row = `"${client.name}","${client.phone}",${monthToExport},${statusText},${datePaidText},${amount}`;
            csvContent += row + '\n';
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `ØªÙ‚Ø±ÙŠØ±_Ø´Ù‡Ø±_${monthToExport}.csv`);
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link);
    });


    // ----------------------------------------------------
    //                 Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ÙˆØªØ£Ù…ÙŠÙ† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
    // ----------------------------------------------------
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.target.closest('.modal').classList.add('hidden');
        });
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¨Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§ 
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
             e.target.classList.add('hidden');
        }
    });

    // ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    if (localStorage.getItem('isLoggedIn') !== 'true') {
        dashboard.classList.add('hidden');
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø¯Ø®Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„ÙØ±Ø¶ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ„ Ù…Ø±Ø©)
        loginScreen.classList.add('hidden');
        loadData();
        renderDashboard();
    }
});
    </script>
</body>
</html>